<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)" />
    <meta name="keywords" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)" />
    <meta name="author" content="كاتدرائية السمائيين" />
    <meta name="theme-color" content="#402958" />
    <meta name="robots" content="noindex, nofollow" />
    <meta
      property="og:title"
      content="اقتراحات الاجتماع | <%= gradeLabel.short || 'الصف' %>"
    />
    <meta property="og:description" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)" />
    <meta property="og:image" content="/UI/icon.png" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="ar_AR" />
    <title>اقتراحات الاجتماع | <%= gradeLabel.short || 'الصف' %></title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/UI/icon.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
  </head>
  <body>
    <div class="notification-container" id="notificationContainer"></div>

    <nav class="main-nav">
      <div class="nav-brand">
        <div class="brand-text">
          <h2>كاتدرائية السمائيين</h2>
          <p>اقتراحات الاجتماع</p>
        </div>
      </div>
      <div class="nav-center">
        <a href="/gift-shop" class="points-badge">
          <i class="fas fa-gift"></i>
          <span id="pointsValue">0</span> نقطة
        </a>
        <div class="nav-buttons">
          <a href="/grades/<%= gradeSlug %>" class="nav-button" data-page="dashboard">
            <i class="fas fa-home"></i>
            صفحة الصف
          </a>
          <a href="/gift-shop" class="nav-button" data-page="gift-shop">
            <i class="fas fa-gift"></i>
            متجر الهدايا
          </a>
          <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            تسجيل الخروج
          </button>
        </div>
      </div>
      <div class="mobile-header-right">
        <div class="mobile-menu-btn" id="mobileMenuBtn">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <div class="mobile-dropdown" id="mobileDropdown">
        <div class="mobile-buttons">
          <a href="/grades/<%= gradeSlug %>" class="nav-button" data-page="dashboard">
            <i class="fas fa-home"></i>
            صفحة الصف
          </a>
          <a href="/gift-shop" class="nav-button">
            <i class="fas fa-gift"></i>
            متجر الهدايا
          </a>
          <button class="nav-button logout-btn-mobile-dropdown" id="logoutBtnMobile">
            <i class="fas fa-sign-out-alt"></i>
            تسجيل الخروج
          </button>
        </div>
      </div>
    </nav>

    <div class="shell">
      <header class="page">
        <div>
          <p class="pill">اقتراح أسبوعي</p>
          <h1>شارك اقتراحك للاجتماع القادم</h1>
          <p class="hint">يمكنك إرسال اقتراح واحد كل أسبوع.</p>
        </div>
        <span class="pill"><%= gradeLabel.short || gradeSlug %></span>
      </header>

      <section class="card">
        <form id="suggestionForm">
          <label for="suggestion">اكتب اقتراحك:</label>
          <textarea
            id="suggestion"
            name="suggestion"
            placeholder="شارك الفكرة أو الموضوع الذي تريد مناقشته في الاجتماع القادم..."
          ></textarea>
          <button type="submit" class="cta" id="submitSuggestion">
            <i class="fas fa-paper-plane"></i>
            إرسال الاقتراح
          </button>
        </form>
      </section>
    </div>

    <footer>
      <p>&copy; 2025 كاتدرائية السمائيين. جميع الحقوق محفوظة.</p>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
      defer
    ></script>
    <script>
      function showNotification(type, title, message, duration = 5000) {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
          success: 'fas fa-check-circle',
          warning: 'fas fa-exclamation-triangle',
          error: 'fas fa-times-circle',
          info: 'fas fa-info-circle'
        };
        
        notification.innerHTML = `
          <i class="notification-icon ${icons[type] || icons.info}"></i>
          <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
          </div>
          <button class="notification-close">
            <i class="fas fa-times"></i>
          </button>
          <div class="notification-progress" style="animation-duration: ${duration}ms"></div>
        `;
        
        container.appendChild(notification);
        
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.onclick = () => {
          notification.classList.add('hiding');
          setTimeout(() => notification.remove(), 400);
        };
        
        const progressBar = notification.querySelector('.notification-progress');
        
        let timeoutId;
        if (duration > 0) {
          timeoutId = setTimeout(() => {
            notification.classList.add('hiding');
            setTimeout(() => notification.remove(), 400);
          }, duration);
        }
        
        notification.addEventListener('mouseenter', () => {
          if (progressBar) progressBar.style.animationPlayState = 'paused';
          if (timeoutId) clearTimeout(timeoutId);
        });
        
        notification.addEventListener('mouseleave', () => {
          if (progressBar) progressBar.style.animationPlayState = 'running';
          if (duration > 0) {
            timeoutId = setTimeout(() => {
              notification.classList.add('hiding');
              setTimeout(() => notification.remove(), 400);
            }, duration - (progressBar ? (parseFloat(getComputedStyle(progressBar).animationDuration) * 1000 - progressBar.getAnimations()[0]?.currentTime * 1000) : duration));
          }
        });
        
        return notification;
      }

      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileDropdown = document.getElementById("mobileDropdown");
      const suggestionBtn = document.getElementById("suggestionBtn");
      const suggestionDropdown = document.getElementById("suggestionDropdown");
      const mobileSuggestionBtn = document.getElementById("mobileSuggestionBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const logoutBtnMobile = document.getElementById("logoutBtnMobile");
      const desktopArrow = document.getElementById("desktopArrow");
      const mobileArrow = document.getElementById("mobileArrow");

      mobileMenuBtn.addEventListener("click", function (e) {
        e.stopPropagation();
        const isActive = mobileDropdown.classList.toggle("active");
        mobileMenuBtn.classList.toggle("active", isActive);
      });

      if (suggestionBtn) {
        suggestionBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          suggestionDropdown.classList.toggle("active");
          desktopArrow.classList.toggle("rotated");
        });
      }

      if (mobileSuggestionBtn) {
        mobileSuggestionBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          showNotification("info", "اقتراحات", "اضغط على رابط اقتراح الاجتماع في القائمة");
        });
      }

      function closeAllDropdowns() {
        suggestionDropdown.classList.remove("active");
        mobileDropdown.classList.remove("active");
        desktopArrow.classList.remove("rotated");
        mobileArrow.classList.remove("rotated");
        mobileMenuBtn.classList.remove("active");
      }

      document.addEventListener("click", function (event) {
        if (
          !suggestionBtn.contains(event.target) &&
          !suggestionDropdown.contains(event.target)
        ) {
          suggestionDropdown.classList.remove("active");
          desktopArrow.classList.remove("rotated");
        }

        if (
          !mobileMenuBtn.contains(event.target) &&
          !mobileDropdown.contains(event.target)
        ) {
          closeAllDropdowns();
        }
      });

      async function performLogout() {
        const result = await Swal.fire({
          title: "تسجيل الخروج",
          text: "هل تريد فعلاً تسجيل الخروج من النظام؟",
          icon: "question",
          iconColor: "#ffcc00",
          showCancelButton: true,
          confirmButtonText: "نعم، تسجيل خروج",
          cancelButtonText: "إلغاء",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
          background: "#2a1b3c",
          color: "#fff",
          backdrop: "rgba(0,0,0,0.85)",
          reverseButtons: false,
          allowOutsideClick: false,
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch("/logout", { method: "POST" });
            if (response.ok) {
              showNotification("success", "تم تسجيل الخروج", "تم إنهاء الجلسة بأمان");
              setTimeout(() => {
                window.location.href = "/";
              }, 1000);
            }
          } catch (error) {
            console.error("Logout error:", error);
            window.location.href = "/";
          }
        }
      }

      if (logoutBtn) {
        logoutBtn.addEventListener("click", performLogout);
      }

      if (logoutBtnMobile) {
        logoutBtnMobile.addEventListener("click", performLogout);
      }

      async function loadUserPoints() {
        try {
          const response = await fetch("/api/gift-shop/my-points");
          if (response.ok) {
            const data = await response.json();
            const points = data.points || 0;
            const pointsValueEl = document.getElementById("pointsValue");
            if (pointsValueEl) {
              pointsValueEl.textContent = points;
            }
          }
        } catch (error) {
          console.error("Error loading points:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadUserPoints();
      });

      const form = document.getElementById("suggestionForm");
      const submitBtn = document.getElementById("submitSuggestion");

      form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = document.getElementById("suggestion").value.trim();
        if (text.length < 5) {
          showNotification("warning", "نص قصير", "اكتب اقتراحاً أوضح قبل الإرسال.");
          return;
        }

        submitBtn.disabled = true;
        const original = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';

        try {
          const res = await fetch("/api/suggestions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text, category: "meeting" }),
          });
          const result = await res.json();
          if (res.ok && result.success) {
            showNotification("success", "تم الإرسال", "شكرًا! تم استلام اقتراحك.");
            form.reset();
            setTimeout(() => {
              window.location.href = "/grades/<%= gradeSlug %>";
            }, 1200);
          } else {
            showNotification("info", "تنبيه", result.message || "تعذر إرسال الاقتراح");
          }
        } catch (err) {
          showNotification("error", "فشل الإرسال", "حدث خطأ في الاتصال. حاول لاحقًا.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = original;
        }
      });

      function hideCurrentPageFromNav() {
        const currentPage = "suggestion";
        const navButtonsToHide = document.querySelectorAll("[data-page]");
        navButtonsToHide.forEach((element) => {
          if (element.getAttribute("data-page") === currentPage) {
            element.style.display = "none";
          }
        });
      }
      document.addEventListener("DOMContentLoaded", hideCurrentPageFromNav);
    </script>
  </body>
</html>