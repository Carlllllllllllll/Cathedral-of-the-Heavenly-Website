<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)"
    />
    <meta
      name="keywords"
      content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)"
    />
    <meta name="author" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†" />
    <meta name="theme-color" content="#402958" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†</title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/UI/icon.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
        <link rel="stylesheet" href="/design/sidebar.css" />
        <link rel="stylesheet" href="/design/user-management.css" />
    <link rel="stylesheet" href="/design/sidebar.css" />
    <link rel="stylesheet" href="/design/user-management.css" />
  </head>
  <body>
    <div class="mobile-toggle" id="mobileToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <img src="/UI/logo.png" alt="Ø§Ù„Ù„ÙˆØºÙˆ" />
          <div class="logo-text">
            <h1>ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
          </div>
        </div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item">
          <a href="https://kenisa-el-sama2eyeen.ooguy.com" class="nav-link">
            <i class="fas fa-home"></i>
            Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          </a>
        </div>
        <div class="nav-item">
          <a href="/form-panel" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
          </a>
        </div>

        <div class="nav-item grades-nav-item">
          <div class="nav-link grades-toggle" id="sidebarGradesToggle">
            <i class="fas fa-graduation-cap"></i>
            Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="grades-submenu-container">
            <div class="grades-submenu" id="sidebarGradesSubmenu">
              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="prep">
                  <i class="fas fa-school"></i>
                  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="prep">
                  <a href="/grades/prep1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£ÙˆÙ„
                  </a>
                  <a href="/grades/prep2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù†ÙŠ
                  </a>
                  <a href="/grades/prep3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù„Ø«
                  </a>
                </div>
              </div>

              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="sec">
                  <i class="fas fa-university"></i>
                  Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="sec">
                  <a href="/grades/sec1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø£ÙˆÙ„
                  </a>
                  <a href="/grades/sec2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù†ÙŠ
                  </a>
                  <a href="/grades/sec3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù„Ø«
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-item">
          <a href="/admin/user-approvals" class="nav-link">
            <i class="fas fa-user-check"></i>
            Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/user-management" class="nav-link active">
            <i class="fas fa-users"></i>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/add" class="nav-link">
            <i class="fas fa-plus-circle"></i>
            Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯ÙŠØ©
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/approvals" class="nav-link">
            <i class="fas fa-check-circle"></i>
            Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          </a>
        </div>
        <div class="nav-item suggestions-nav-item">
          <div class="nav-link suggestions-toggle" id="suggestionsToggle">
            <i class="fas fa-lightbulb"></i>
            Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="suggestions-submenu-container">
            <div class="suggestions-submenu" id="suggestionsSubmenu">
              <a
                href="/admin/suggestion/ektma3at"
                class="nav-link submenu-link"
              >
                <i class="fas fa-users"></i>
                Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª
              </a>
            </div>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="top-nav">
        <div class="user-info">
          <img src="/UI/pfp.jpg" alt="Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" class="user-avatar" />
          <div class="user-details">
            <h3 id="username">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <span id="userRole">Ù…Ø´Ø±Ù</span>
          </div>
          <button class="logout-btn-mobile" id="logoutBtnMobile">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </header>

      <div class="admin-container">
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>

        <div class="user-management-tools">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="searchInput"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..."
            />
            <button id="clearSearch" class="clear-search">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="tools-middle">
            <div class="category-dropdown" id="categoryDropdown">
              <button class="category-toggle" id="categoryToggle">
                <i class="fas fa-filter"></i>
                ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-grid">
                  <div class="dropdown-column">
                    <h4><i class="fas fa-users"></i> Ø¹Ø§Ù…</h4>
                    <div class="category-option active" data-category="all">
                      <i class="fas fa-users"></i>
                      Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                      <span class="category-count" id="count-all">0</span>
                    </div>
                  </div>
                  <div class="dropdown-column">
                    <h4><i class="fas fa-university"></i> Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©</h4>
                    <div class="category-option" data-category="sec1">
                      <i class="fas fa-user-graduate"></i>
                      Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ
                      <span class="category-count" id="count-sec1">0</span>
                    </div>
                    <div class="category-option" data-category="sec2">
                      <i class="fas fa-user-graduate"></i>
                      Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ
                      <span class="category-count" id="count-sec2">0</span>
                    </div>
                    <div class="category-option" data-category="sec3">
                      <i class="fas fa-user-graduate"></i>
                      Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ
                      <span class="category-count" id="count-sec3">0</span>
                    </div>
                  </div>
                  <div class="dropdown-column">
                    <h4><i class="fas fa-school"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©</h4>
                    <div class="category-option" data-category="prep1">
                      <i class="fas fa-user-graduate"></i>
                      Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ
                      <span class="category-count" id="count-prep1">0</span>
                    </div>
                    <div class="category-option" data-category="prep2">
                      <i class="fas fa-user-graduate"></i>
                      Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ
                      <span class="category-count" id="count-prep2">0</span>
                    </div>
                    <div class="category-option" data-category="prep3">
                      <i class="fas fa-user-graduate"></i>
                      Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ
                      <span class="category-count" id="count-prep3">0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="view-toggles">
            <button id="toggleViewBtn" class="toggle-btn">
              <i class="fas fa-ban"></i>
              Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
            </button>
            <button id="refreshUsersBtn" class="toggle-btn">
              <i class="fas fa-sync-alt"></i>
              ØªØ­Ø¯ÙŠØ«
            </button>
          </div>
        </div>

        <div id="usersSection">
          <h2 class="section-title">
            <i class="fas fa-users"></i>
            Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†
          </h2>
          <div id="usersList" class="users-grid">
            <div class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
            </div>
          </div>
        </div>

        <div id="bannedSection" style="display: none">
          <h2 class="section-title">
            <i class="fas fa-user-slash"></i>
            Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†
          </h2>
          <div id="bannedUsersList" class="users-grid"></div>
        </div>
      </div>
    </main>

    <div id="editUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
          <button class="close-button" id="closeEditModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserId" />
            <div class="form-group">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„:</label>
              <input type="text" id="editFirstName" required />
            </div>
            <div class="form-group">
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ:</label>
              <input type="text" id="editSecondName" required />
            </div>
            <div class="form-group">
              <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
              <input type="email" id="editEmail" required />
            </div>
            <div class="form-group">
              <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
              <input type="text" id="editPhone" required />
            </div>
            <div class="form-group">
              <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
              <select id="editGrade" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ...</option>
                <option value="prep1">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£ÙˆÙ„Ù‰</option>
                <option value="prep2">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù†ÙŠØ©</option>
                <option value="prep3">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù„Ø«Ø©</option>
                <option value="sec1">Ø«Ø§Ù†ÙˆÙŠ Ø£ÙˆÙ„Ù‰</option>
                <option value="sec2">Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù†ÙŠØ©</option>
                <option value="sec3">Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù„Ø«Ø©</option>
                <option value="teachers">Ø®Ø§Ø¯Ù…</option>
                <option value="admins">Ù…Ø´Ø±Ù</option>
              </select>
            </div>
            <div class="form-group">
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
              <input type="password" id="editPassword" />
            </div>
            <div class="form-actions">
              <button type="submit" class="submit-btn" id="editSubmitBtn">
                <span id="editBtnText">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</span>
                <span id="editBtnLoading" style="display: none">
                  <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...
                </span>
              </button>
              <button type="button" class="cancel-btn" id="cancelEditModal">
                Ø¥Ù„ØºØ§Ø¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="takePointsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-star"></i> Ø®ØµÙ… Ù†Ù‚Ø§Ø·</h2>
          <button class="close-button" id="closeTakePointsModalBtn">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="takePointsForm">
            <input type="hidden" id="takePointsUserId" />
            <div class="form-group">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·:</label>
              <input type="number" id="takePointsAmount" required min="1" />
            </div>
            <div class="form-group">
              <label>Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
              <textarea id="takePointsReason"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="submit-btn" id="takePointsSubmitBtn">
                <span id="takePointsBtnText">Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                <span id="takePointsBtnLoading" style="display: none">
                  <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...
                </span>
              </button>
              <button
                type="button"
                class="cancel-btn"
                id="cancelTakePointsModal"
              >
                Ø¥Ù„ØºØ§Ø¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="banModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-ban"></i> Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
          <button class="close-button" id="closeBanModal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="banForm">
            <input type="hidden" id="banUserId" />
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¸Ø±:</label>
              <select id="banType" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¸Ø±...</option>
                <option value="all">Ø­Ø¸Ø± ÙƒØ§Ù…Ù„</option>
                <option value="forms">Ø­Ø¸Ø± Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙÙ‚Ø·</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
              <textarea id="banReason" placeholder="Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±"></textarea>
            </div>
            <div class="form-actions">
              <button
                type="submit"
                class="submit-btn"
                id="banSubmitBtn"
                style="background: linear-gradient(135deg, #e74c3c, #c0392b)"
              >
                <span id="banBtnText">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                <span id="banBtnLoading" style="display: none">
                  <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...
                </span>
              </button>
              <button type="button" class="cancel-btn" id="cancelBanModal">
                Ø¥Ù„ØºØ§Ø¡
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
      defer
    ></script>
<script>
        const mobileToggle = document.getElementById("mobileToggle");
      const sidebar = document.getElementById("sidebar");
      const logoutBtn = document.getElementById("logoutBtn");
      const logoutBtnMobile = document.getElementById("logoutBtnMobile");
      const usersList = document.getElementById("usersList");
      const bannedUsersList = document.getElementById("bannedUsersList");
      const toggleViewBtn = document.getElementById("toggleViewBtn");
      const refreshUsersBtn = document.getElementById("refreshUsersBtn");
      const searchInput = document.getElementById("searchInput");
      const clearSearch = document.getElementById("clearSearch");
      const usersSection = document.getElementById("usersSection");
      const bannedSection = document.getElementById("bannedSection");
      const takePointsModal = document.getElementById("takePointsModal");
      const takePointsForm = document.getElementById("takePointsForm");
      const banModal = document.getElementById("banModal");
      const banForm = document.getElementById("banForm");
      const editUserModal = document.getElementById("editUserModal");
      const editUserForm = document.getElementById("editUserForm");
      const categoryNav = document.getElementById("categoryNav");
      const categoryTabs = document.querySelectorAll(".category-tab");
      const sidebarGradesToggle = document.getElementById(
        "sidebarGradesToggle"
      );
      const sidebarGradesSubmenu = document.getElementById(
        "sidebarGradesSubmenu"
      );
      const closeEditModal = document.getElementById("closeEditModal");
      const cancelEditModal = document.getElementById("cancelEditModal");
      const closeTakePointsModalBtn = document.getElementById(
        "closeTakePointsModalBtn"
      );
      const cancelTakePointsModal = document.getElementById(
        "cancelTakePointsModal"
      );
      const closeBanModalBtn = document.getElementById("closeBanModal");
      const cancelBanModal = document.getElementById("cancelBanModal");
      const categoryDropdown = document.getElementById("categoryDropdown");
      const categoryToggle = document.getElementById("categoryToggle");
      const dropdownMenu = document.getElementById("dropdownMenu");
      const categoryOptions = document.querySelectorAll(".category-option");

      let allUsers = [];
      let allBannedUsers = [];
      let currentCategory = "all";
      let userCounts = {
        all: 0,
        sec1: 0,
        sec2: 0,
        sec3: 0,
        prep1: 0,
        prep2: 0,
        prep3: 0,
        teachers: 0,
        admins: 0,
      };

      function toggleSidebar() {
        sidebar.classList.toggle("active");
        const spans = mobileToggle.querySelectorAll("span");
        if (sidebar.classList.contains("active")) {
          spans[0].style.transform = "rotate(45deg) translate(5px, 5px)";
          spans[1].style.opacity = "0";
          spans[2].style.transform = "rotate(-45deg) translate(7px, -6px)";
        } else {
          spans[0].style.transform = "none";
          spans[1].style.opacity = "1";
          spans[2].style.transform = "none";
        }
      }

      mobileToggle.addEventListener("click", toggleSidebar);

      async function loadUserInfo() {
        try {
          const response = await fetch("/api/user-info");
          const data = await response.json();
          if (!data.isAuthenticated) {
            window.location.href = "/login";
            return;
          }
          document.getElementById("username").textContent = data.username;
          document.getElementById("userRole").textContent =
            data.role === "leadadmin"
              ? "Ù‚Ø§Ø¦Ø¯ Ø¹Ø§Ù…"
              : data.role === "admin"
              ? "Ù…Ø´Ø±Ù"
              : data.role;
        } catch (error) {
          console.error("Error loading user info:", error);
        }
      }

      function updateCategoryCounts() {
        userCounts = {
          all: allUsers.length,
          sec1: allUsers.filter((user) => user.grade === "sec1").length,
          sec2: allUsers.filter((user) => user.grade === "sec2").length,
          sec3: allUsers.filter((user) => user.grade === "sec3").length,
          prep1: allUsers.filter((user) => user.grade === "prep1").length,
          prep2: allUsers.filter((user) => user.grade === "prep2").length,
          prep3: allUsers.filter((user) => user.grade === "prep3").length,
          teachers: allUsers.filter((user) => user.grade === "teachers").length,
          admins: allUsers.filter((user) => user.grade === "admins").length,
        };

        for (const category in userCounts) {
          const countElement = document.getElementById(`count-${category}`);
          if (countElement) {
            countElement.textContent = userCounts[category];
          }
        }
      }

      async function loadUsers() {
        console.log("loadUsers() called at", new Date().toLocaleTimeString());
        try {
          usersList.innerHTML = `
          <div class="loading-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
          </div>
      `;

          const response = await fetch("/api/admin/users");
          const allUsersFromAPI = await response.json();

          const bannedResponse = await fetch("/api/banned-users");
          const bannedUsers = await bannedResponse.json();
          allBannedUsers = Array.isArray(bannedUsers) ? bannedUsers : [];

          const bannedUsernames = allBannedUsers.map((user) => user.username);

          const activeUsers = allUsersFromAPI.filter(
            (user) => !bannedUsernames.includes(user.username)
          );

          allUsers = activeUsers;

          if (!activeUsers || activeUsers.length === 0) {
            usersList.innerHTML = `
              <div class="empty-state">
                  <i class="fas fa-users-slash"></i>
                  <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†</h3>
                  <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
              </div>
          `;
            updateCategoryCounts();
            return;
          }

          updateCategoryCounts();
          displayUsersByCategory(currentCategory);
        } catch (error) {
          console.error("Error loading users:", error);
          usersList.innerHTML = `
          <div class="empty-state">
              <i class="fas fa-exclamation-circle"></i>
              <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
              <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
          </div>
      `;
        }
      }

      function displayUsersByCategory(category) {
        let filteredUsers = allUsers;

        if (category !== "all") {
          filteredUsers = allUsers.filter((user) => user.grade === category);
        }

        if (filteredUsers.length === 0) {
          usersList.innerHTML = `
          <div class="empty-state">
              <i class="fas fa-users-slash"></i>
              <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>
              <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</p>
          </div>
      `;
        } else {
          displayUsers(filteredUsers);
        }
      }

      function displayUsers(users) {
    const statusRank = { online: 0, idle: 1, "signed-in": 2, "signed-out": 3, banned: 4 };
    const sorted = [...users].sort((a, b) => {
      const aStatus = getUserStatus(a);
      const bStatus = getUserStatus(b);
      const aRank = statusRank[aStatus] ?? 99;
      const bRank = statusRank[bStatus] ?? 99;
      if (aRank !== bRank) return aRank - bRank;
      const aTime = a.lastActivity ? new Date(a.lastActivity).getTime() : 0;
      const bTime = b.lastActivity ? new Date(b.lastActivity).getTime() : 0;
      if (bTime !== aTime) return bTime - aTime;
      return (a.username || "").localeCompare(b.username || "");
    });

    usersList.innerHTML = sorted
        .map((user) => {
            const gradeText = {
                prep1: "Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£ÙˆÙ„Ù‰",
                prep2: "Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù†ÙŠØ©",
                prep3: "Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù„Ø«Ø©",
                sec1: "Ø«Ø§Ù†ÙˆÙŠ Ø£ÙˆÙ„Ù‰",
                sec2: "Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù†ÙŠØ©",
                sec3: "Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù„Ø«Ø©",
                teachers: "Ø®Ø§Ø¯Ù…",
                admins: "Ù…Ø´Ø±Ù",
            }[user.grade] || user.grade;

            const roleText = {
                leadadmin: "Ù‚Ø§Ø¦Ø¯ Ø¹Ø§Ù…",
                admin: "Ù…Ø´Ø±Ù",
                teacher: "Ø®Ø§Ø¯Ù…",
                student: "Ø·Ø§Ù„Ø¨",
            }[user.role] || user.role;

            const userStatus = getUserStatus(user);
            const statusBadge = getStatusBadge(userStatus);
            
            const verificationBadge = user.verificationCodeVerified ? 
                '<span class="status-badge verified-badge">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚</span>' : 
                '<span class="status-badge not-verified-badge">âŒ ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚</span>';
            
            const lastActivityText = user.lastActivity ? 
                `Ø¢Ø®Ø± Ù†Ø´Ø§Ø·: ${formatTimeAgo(new Date(user.lastActivity))}` : 
                'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯';

            const logoutAllDevicesBtn =
                user.role !== "leadadmin"
                    ? `
                    <button class="action-btn logout-all-btn" onclick="logoutAllDevices('${user._id}', '${user.username}')">
                        <i class="fas fa-sign-out-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                    </button>
                    `
                    : "";

            return `
                <div class="user-card">
                    <div class="user-card-header">
                        <div class="user-avatar-large ${userStatus === 'banned' ? 'banned-avatar' : ''}">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-main-info">
                            <h3>${user.firstName} ${user.secondName}</h3>
                            <div class="user-badges">
                                <span class="username-badge">@${user.username}</span>
                                <span class="role-badge ${user.role}">${roleText}</span>
                                <span class="grade-badge">${gradeText}</span>
                                ${statusBadge}
                                ${verificationBadge}
                            </div>
                            <div class="user-status-info">
                                <small class="last-login-text">${lastActivityText}</small>
                            </div>
                        </div>
                        <div class="user-points">
                            <i class="fas fa-star"></i>
                            <span>${user.points || 0}</span>
                        </div>
                    </div>
                    
                    <div class="user-card-details">
                        <div class="detail-row">
                            <span class="detail-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value">${user.email}</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯" onclick="copyText('${user.email.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value">${user.phone}</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" onclick="copyText('${user.phone.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value">${new Date(user.createdAt).toLocaleDateString("ar-EG")}</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„" onclick="copyText('${new Date(user.createdAt).toLocaleDateString("ar-EG")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ø¢Ø®Ø± Ù†Ø´Ø§Ø·:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value">${
                                user.lastActivity
                                    ? new Date(user.lastActivity).toLocaleString("ar-EG")
                                    : "Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯"
                            }</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø¢Ø®Ø± Ù†Ø´Ø§Ø·" onclick="copyText('${(user.lastActivity ? new Date(user.lastActivity).toLocaleString("ar-EG") : "Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯").replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value">${getStatusDescription(userStatus)}</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨" onclick="copyText('${getStatusDescription(userStatus).replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        ${user.verificationCodeVerified
                            ? `
                        <div class="detail-row" style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 8px; padding: 12px; margin-top: 10px;">
                            <span class="detail-label" style="color: #2ecc71; font-weight: 700;">âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value" style="color: #2ecc71; font-weight: 700; font-size: 16px;">Ù…ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚" onclick="copyText('Ù…ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        `
                            : user.verificationCode ? 
                            `
                        <div class="detail-row" style="background: rgba(255, 204, 0, 0.1); border: 1px solid rgba(255, 204, 0, 0.3); border-radius: 8px; padding: 12px; margin-top: 10px;">
                            <span class="detail-label" style="color: #ffcc00; font-weight: 700;">ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚:</span>
                            <span class="detail-value-wrap">
                              <span class="detail-value" style="color: #ffcc00; font-weight: 700; font-size: 16px; font-family: monospace;">${user.verificationCode}</span>
                              <button class="copy-btn" type="button" title="Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚" onclick="copyText('${user.verificationCode.replace(/'/g, "\\'")}')">
                                <i class="fas fa-copy"></i>
                              </button>
                            </span>
                        </div>
                        ` : ''
                            }
                    </div>
                    
                    <div class="user-card-actions">
                        <button class="action-btn points-btn" onclick="givePoints('${user._id}', '${user.username}')">
                            <i class="fas fa-plus-circle"></i>
                            Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·
                        </button>
                        <button class="action-btn remove-points-btn" onclick="openTakePointsModal('${user._id}', '${user.username}')">
                            <i class="fas fa-minus-circle"></i>
                            Ø®ØµÙ… Ù†Ù‚Ø§Ø·
                        </button>
                        <button class="action-btn edit-btn" onclick="openEditUserModal('${user._id}')">
                            <i class="fas fa-edit"></i>
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button class="action-btn ban-btn" onclick="openBanModal('${user._id}', '${user.username}')">
                            <i class="fas fa-ban"></i>
                            Ø­Ø¸Ø±
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user._id}', '${user.username}')">
                            <i class="fas fa-trash"></i>
                            Ø­Ø°Ù
                        </button>
                        ${logoutAllDevicesBtn}
                    </div>
                </div>
            `;
        })
        .join("");
}
      async function logoutAllDevices(userId, username) {
        const result = await Swal.fire({
          title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©",
          text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ "${username}" Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©ØŸ`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#3498db",
          cancelButtonColor: "#666",
        });

        if (result.isConfirmed) {
          Swal.fire({
            title: "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬...",
            text: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©",
            icon: "info",
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          try {
            const response = await fetch(
              `/api/admin/users/${userId}/logout-all`,
              {
                method: "POST",
              }
            );

            Swal.close();

            if (response.ok) {
              Swal.fire({
                title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                text: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©",
                icon: "success",
                confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                confirmButtonColor: "#ffcc00",
              });
            } else {
              throw new Error("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©");
            }
          } catch (error) {
            Swal.fire({
              title: "Ø®Ø·Ø£!",
              text: error.message || "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©",
              icon: "error",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            });
          }
        }
      }

      function openEditUserModal(userId) {
        const user = allUsers.find((u) => u._id === userId);
        if (!user) return;

        document.getElementById("editUserId").value = userId;
        document.getElementById("editFirstName").value = user.firstName;
        document.getElementById("editSecondName").value = user.secondName;
        document.getElementById("editEmail").value = user.email;
        document.getElementById("editPhone").value = user.phone;
        document.getElementById("editGrade").value = user.grade;
        document.getElementById("editPassword").value = "";

        editUserModal.classList.add("active");
      }

      function closeEditUserModal() {
        editUserModal.classList.remove("active");
      }

      editUserForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const userId = document.getElementById("editUserId").value;
        const firstName = document.getElementById("editFirstName").value;
        const secondName = document.getElementById("editSecondName").value;
        const email = document.getElementById("editEmail").value;
        const phone = document.getElementById("editPhone").value;
        const grade = document.getElementById("editGrade").value;
        const password = document.getElementById("editPassword").value;
        const editSubmitBtn = document.getElementById("editSubmitBtn");
        const editBtnText = document.getElementById("editBtnText");
        const editBtnLoading = document.getElementById("editBtnLoading");

        editSubmitBtn.disabled = true;
        editBtnText.style.display = "none";
        editBtnLoading.style.display = "inline";

        try {
          const updateData = {
            firstName,
            secondName,
            email,
            phone,
            grade,
          };
          if (password) updateData.password = password;

          const response = await fetch(`/api/admin/users/${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updateData),
          });

          if (response.ok) {
            closeEditUserModal();
            Swal.fire({
              title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
              text: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
              icon: "success",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
              confirmButtonColor: "#ffcc00",
            });
            loadUsers();
          } else {
            throw new Error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
          }
        } catch (error) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: error.message || "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
        } finally {
          editSubmitBtn.disabled = false;
          editBtnText.style.display = "inline";
          editBtnLoading.style.display = "none";
        }
      });

      closeEditModal.addEventListener("click", closeEditUserModal);
      cancelEditModal.addEventListener("click", closeEditUserModal);

      function openTakePointsModal(userId, username) {
        document.getElementById("takePointsUserId").value = userId;
        document.getElementById("takePointsAmount").value = "";
        document.getElementById("takePointsReason").value = "";
        takePointsModal.classList.add("active");
      }

      function closeTakePointsModal() {
        takePointsModal.classList.remove("active");
      }

      takePointsForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const userId = document.getElementById("takePointsUserId").value;
        const amount = document.getElementById("takePointsAmount").value;
        const reason = document.getElementById("takePointsReason").value;

        if (!amount || amount < 1) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
          return;
        }

        const takePointsSubmitBtn = document.getElementById(
          "takePointsSubmitBtn"
        );
        const takePointsBtnText = document.getElementById("takePointsBtnText");
        const takePointsBtnLoading = document.getElementById(
          "takePointsBtnLoading"
        );

        takePointsSubmitBtn.disabled = true;
        takePointsBtnText.style.display = "none";
        takePointsBtnLoading.style.display = "inline";

        try {
          const response = await fetch(
            `/api/admin/users/${userId}/remove-points`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ amount, reason }),
            }
          );

          if (response.ok) {
            closeTakePointsModal();
            Swal.fire({
              title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
              text: `ØªÙ… Ø®ØµÙ… ${amount} Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…`,
              icon: "success",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
              confirmButtonColor: "#ffcc00",
            });
            loadUsers();
          } else {
            throw new Error("ÙØ´Ù„ Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·");
          }
        } catch (error) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: error.message || "ØªØ¹Ø°Ø± Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
        } finally {
          takePointsSubmitBtn.disabled = false;
          takePointsBtnText.style.display = "inline";
          takePointsBtnLoading.style.display = "none";
        }
      });

      closeTakePointsModalBtn.addEventListener("click", closeTakePointsModal);
      cancelTakePointsModal.addEventListener("click", closeTakePointsModal);

      function openBanModal(userId, username) {
        document.getElementById("banUserId").value = userId;
        document.getElementById("banType").value = "";
        document.getElementById("banReason").value = "";
        banModal.classList.add("active");
      }

      function closeBanModal() {
        banModal.classList.remove("active");
      }

      banForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const userId = document.getElementById("banUserId").value;
        const banType = document.getElementById("banType").value;
        const reason = document.getElementById("banReason").value;

        const banSubmitBtn = document.getElementById("banSubmitBtn");
        const banBtnText = document.getElementById("banBtnText");
        const banBtnLoading = document.getElementById("banBtnLoading");

        if (!banType) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¸Ø±",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
          return;
        }

        banSubmitBtn.disabled = true;
        banBtnText.style.display = "none";
        banBtnLoading.style.display = "inline";

        try {
          const userResponse = await fetch(`/api/admin/users/${userId}`);
          const user = await userResponse.json();

          const response = await fetch(`/api/banned-users`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: user.username,
              banType: banType,
              reason: reason,
            }),
          });

          if (response.ok) {
            closeBanModal();
            Swal.fire({
              title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
              text: "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
              icon: "success",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
              confirmButtonColor: "#ffcc00",
            });
            loadUsers();
            loadBannedUsers();
          } else {
            throw new Error("ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
          }
        } catch (error) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: error.message || "ØªØ¹Ø°Ø± Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
        } finally {
          banSubmitBtn.disabled = false;
          banBtnText.style.display = "inline";
          banBtnLoading.style.display = "none";
        }
      });

      closeBanModalBtn.addEventListener("click", closeBanModal);
      cancelBanModal.addEventListener("click", closeBanModal);

      async function loadBannedUsers() {
        try {
          const response = await fetch("/api/banned-users");
          const bannedUsers = await response.json();
          allBannedUsers = bannedUsers;

          if (!bannedUsers || bannedUsers.length === 0) {
            bannedUsersList.innerHTML = `
              <div class="empty-state">
                  <i class="fas fa-user-check"></i>
                  <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†</h3>
                  <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
              </div>
          `;
            return;
          }

          displayBannedUsers(bannedUsers);
        } catch (error) {
          console.error("Error loading banned users:", error);
          bannedUsersList.innerHTML = `
          <div class="empty-state">
              <i class="fas fa-exclamation-circle"></i>
              <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
              <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
          </div>
      `;
        }
      }

      function searchUsers() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (searchTerm) {
          clearSearch.style.display = "flex";
        } else {
          clearSearch.style.display = "none";
        }

        if (!searchTerm) {
          displayUsersByCategory(currentCategory);
          return;
        }

        const filteredUsers = allUsers.filter((user) => {
          return (
            user.firstName.toLowerCase().includes(searchTerm) ||
            user.secondName.toLowerCase().includes(searchTerm) ||
            user.username.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.phone.includes(searchTerm)
          );
        });

        if (filteredUsers.length === 0) {
          usersList.innerHTML = `
          <div class="empty-state">
              <i class="fas fa-search"></i>
              <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
              <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø¨Ø­Ø«Ùƒ</p>
          </div>
      `;
        } else {
          displayUsers(filteredUsers);
        }
      }

      async function givePoints(userId, username) {
        const { value: formValues } = await Swal.fire({
          title: "Ø¥Ø¹Ø·Ø§Ø¡ Ù†Ù‚Ø§Ø·",
          html: `
          <input id="swal-amount" class="swal2-input" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·" type="number" min="1" required>
          <input id="swal-reason" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¨Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      `,
          focusConfirm: false,
          showCancelButton: true,
          confirmButtonText: "Ø¥Ø¹Ø·Ø§Ø¡",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#27ae60",
          cancelButtonColor: "#666",
          preConfirm: () => {
            return {
              amount: document.getElementById("swal-amount").value,
              reason: document.getElementById("swal-reason").value,
            };
          },
        });

        if (formValues && formValues.amount) {
          try {
            const response = await fetch(
              `/api/admin/users/${userId}/give-points`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formValues),
              }
            );

            if (response.ok) {
              Swal.fire({
                title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                text: `ØªÙ… Ø¥Ø¹Ø·Ø§Ø¡ ${formValues.amount} Ù†Ù‚Ø·Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… @${username}`,
                icon: "success",
                confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                confirmButtonColor: "#ffcc00",
              });
              loadUsers();
            } else {
              throw new Error("ÙØ´Ù„ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø§Ø·");
            }
          } catch (error) {
            Swal.fire({
              title: "Ø®Ø·Ø£!",
              text: error.message || "ØªØ¹Ø°Ø± Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø§Ø·",
              icon: "error",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            });
          }
        }
      }

      async function deleteUser(userId, username) {
        const result = await Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
        });

        if (result.isConfirmed) {
          Swal.fire({
            title: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...",
            text: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            icon: "info",
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          try {
            const response = await fetch(`/api/admin/users/${userId}`, {
              method: "DELETE",
            });

            Swal.close();

            if (response.ok) {
              Swal.fire({
                title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                text: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
                icon: "success",
                confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                confirmButtonColor: "#ffcc00",
              });
              loadUsers();
            } else {
              throw new Error("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            }
          } catch (error) {
            Swal.fire({
              title: "Ø®Ø·Ø£!",
              text: error.message || "ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
              icon: "error",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            });
          }
        }
      }

      async function unbanUser(username) {
        const result = await Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${username}"ØŸ`,
          icon: "question",
          showCancelButton: true,
          confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#27ae60",
          cancelButtonColor: "#666",
        });

        if (result.isConfirmed) {
          Swal.fire({
            title: "Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±...",
            text: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            icon: "info",
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });

          try {
            const response = await fetch(
              `/api/banned-users/${encodeURIComponent(username)}`,
              { method: "DELETE" }
            );

            Swal.close();

            if (response.ok) {
              Swal.fire({
                title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                text: "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­",
                icon: "success",
                confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                confirmButtonColor: "#ffcc00",
              });
              loadUsers();
              loadBannedUsers();
            } else {
              throw new Error("ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
            }
          } catch (error) {
            Swal.fire({
              title: "Ø®Ø·Ø£!",
              text: error.message || "ØªØ¹Ø°Ø± Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
              icon: "error",
              confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            });
          }
        }
      }

function toggleView() {
    if (bannedSection.style.display === "none") {
        usersSection.style.display = "none";
        bannedSection.style.display = "block";
        toggleViewBtn.innerHTML = '<i class="fas fa-users"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†';
        
        loadBannedUsers();
    } else {
        usersSection.style.display = "block";
        bannedSection.style.display = "none";
        toggleViewBtn.innerHTML = '<i class="fas fa-ban"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†';
        
        displayUsersByCategory(currentCategory);
    }
}
      async function performLogout() {
        const result = await Swal.fire({
          title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
          text: "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ",
          icon: "question",
          iconColor: "#ffcc00",
          showCancelButton: true,
          confirmButtonText: "Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
          background: "#2a1b3c",
          color: "#fff",
          backdrop: "rgba(0,0,0,0.8)",
          allowOutsideClick: false,
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch("/logout", { method: "POST" });
            if (response.ok) {
              await Swal.fire({
                title: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                text: "ÙˆØ¯Ø§Ø¹Ø§Ù‹! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ù†Ø¬Ø§Ø­",
                icon: "success",
                iconColor: "#27ae60",
                background: "#2a1b3c",
                color: "#fff",
                backdrop: "rgba(0,0,0,0.8)",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "/";
              }, 500);
            }
          } catch (error) {
            console.error("Logout error:", error);
            window.location.href = "/";
          }
        }
      }

      logoutBtn.addEventListener("click", performLogout);
      logoutBtnMobile.addEventListener("click", performLogout);
      toggleViewBtn.addEventListener("click", toggleView);
      refreshUsersBtn.addEventListener("click", () => {
        loadUsers();
        if (bannedSection.style.display !== "none") {
          loadBannedUsers();
        }
      });
      searchInput.addEventListener("input", searchUsers);
      clearSearch.addEventListener("click", () => {
        searchInput.value = "";
        clearSearch.style.display = "none";
        displayUsersByCategory(currentCategory);
      });

      categoryTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          categoryTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentCategory = tab.dataset.category;
          displayUsersByCategory(currentCategory);
        });
      });

      document.addEventListener("click", function (event) {
        if (window.innerWidth <= 992) {
          if (
            !sidebar.contains(event.target) &&
            !mobileToggle.contains(event.target)
          ) {
            sidebar.classList.remove("active");
            const spans = mobileToggle.querySelectorAll("span");
            spans[0].style.transform = "none";
            spans[1].style.opacity = "1";
            spans[2].style.transform = "none";
          }
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo();
        loadUsers();
      });

      if (sidebarGradesToggle) {
        sidebarGradesToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            sidebarGradesSubmenu.style.maxHeight =
              Math.min(sidebarGradesSubmenu.scrollHeight, 400) + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            sidebarGradesSubmenu.style.maxHeight = "0";
            document
              .querySelectorAll(".section-toggle.active")
              .forEach((toggle) => {
                toggle.classList.remove("active");
                const subIcon = toggle.querySelector(".toggle-icon");
                subIcon.classList.remove("fa-chevron-up");
                subIcon.classList.add("fa-chevron-down");
                const sectionSub = document.querySelector(
                  `.section-submenu[data-section="${toggle.dataset.section}"]`
                );
                if (sectionSub) sectionSub.style.maxHeight = "0";
              });
          }
        });
      }

      const sectionToggles = document.querySelectorAll(".section-toggle");
      sectionToggles.forEach((toggle) => {
        toggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          const sectionSub = document.querySelector(
            `.section-submenu[data-section="${this.dataset.section}"]`
          );

          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            sectionSub.style.maxHeight = sectionSub.scrollHeight + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            sectionSub.style.maxHeight = "0";
          }
        });
      });

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeEditUserModal();
          closeTakePointsModal();
          closeBanModal();
        }
      });

      window.addEventListener("click", function (event) {
        if (event.target === editUserModal) closeEditUserModal();
        if (event.target === takePointsModal) closeTakePointsModal();
        if (event.target === banModal) closeBanModal();
      });

      if (categoryToggle) {
        categoryToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          e.preventDefault();
          categoryDropdown.classList.toggle("active");

          if (categoryDropdown.classList.contains("active")) {
            dropdownMenu.style.animation = "fadeInUp 0.3s ease";
          }
        });
      }

      categoryOptions.forEach((option) => {
        option.addEventListener("click", function () {
          const category = this.dataset.category;

          categoryOptions.forEach((opt) => opt.classList.remove("active"));

          this.classList.add("active");

          currentCategory = category;
          displayUsersByCategory(category);

          const optionText = this.textContent
            .replace(this.querySelector(".category-count").textContent, "")
            .trim();
          categoryToggle.innerHTML = `
      <i class="fas fa-filter"></i>
      ${optionText}
      <i class="fas fa-chevron-down"></i>
  `;

          categoryDropdown.classList.remove("active");
        });
      });

      document.addEventListener("click", function (e) {
        if (categoryDropdown && !categoryDropdown.contains(e.target)) {
          categoryDropdown.classList.remove("active");
        }
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && categoryDropdown) {
          categoryDropdown.classList.remove("active");
        }
      });

      const suggestionsToggle = document.getElementById("suggestionsToggle");
      const suggestionsSubmenu = document.getElementById("suggestionsSubmenu");

      if (suggestionsToggle) {
        suggestionsToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            suggestionsSubmenu.style.maxHeight =
              suggestionsSubmenu.scrollHeight + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        });
      }

      document.addEventListener("click", function (e) {
        if (!e.target.closest(".suggestions-nav-item")) {
          const suggestionsToggle =
            document.getElementById("suggestionsToggle");
          const suggestionsSubmenu =
            document.getElementById("suggestionsSubmenu");

          if (
            suggestionsToggle &&
            suggestionsToggle.classList.contains("active")
          ) {
            suggestionsToggle.classList.remove("active");
            const icon = suggestionsToggle.querySelector(".toggle-icon");
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        }
      });

      async function copyText(text) {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
          }

          await Swal.fire({
            title: "ØªÙ… Ø§Ù„Ù†Ø³Ø®",
            text: "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­",
            icon: "success",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            confirmButtonColor: "#ffcc00",
            timer: 1600,
            timerProgressBar: true,
          });
        } catch (e) {
          await Swal.fire({
            title: "ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®",
            text: "ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            confirmButtonColor: "#e74c3c",
          });
        }
      }

      function getUserStatus(user) {
        if (isUserBanned(user)) return "banned";

        if (!user?.lastActivity) return "signed-out";

        const lastActivity = new Date(user.lastActivity);
        if (Number.isNaN(lastActivity.getTime())) return "signed-out";

        const now = Date.now();
        const diffMinutes = Math.floor((now - lastActivity.getTime()) / 60000);

        const ONLINE_THRESHOLD_MINUTES = 2;
        const IDLE_THRESHOLD_MINUTES = 30;

        if (diffMinutes <= ONLINE_THRESHOLD_MINUTES) return "online";
        if (diffMinutes <= IDLE_THRESHOLD_MINUTES) return "idle";
        
        return "signed-in";
      }

      function isUserBanned(user) {
        return allBannedUsers.some(banned => banned.username === user.username);
      }

      function getStatusBadge(status) {
        const badges = {
            'online': '<span class="status-badge online-badge">ğŸŸ¢ Ù…ØªØµÙ„</span>',
            'idle': '<span class="status-badge idle-badge">ğŸŸ  ØºÙŠØ± Ù†Ø´Ø·</span>',
            'signed-in': '<span class="status-badge signed-in-badge">ğŸ”µ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</span>',
            'signed-out': '<span class="status-badge signed-out-badge">âš« ØºÙŠØ± Ù…ØªØµÙ„</span>',
            'banned': '<span class="status-badge banned-badge">ğŸ”´ Ù…Ø­Ø¸ÙˆØ±</span>'
        };
        
        return badges[status] || badges['signed-out'];
      }

      function getStatusDescription(status) {
        const descriptions = {
            'online': 'Ù…ØªØµÙ„',
            'idle': 'ØºÙŠØ± Ù†Ø´Ø·',
            'signed-in': 'Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„',
            'signed-out': 'ØºÙŠØ± Ù…ØªØµÙ„',
            'banned': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±'
        };
        
        return descriptions[status] || 'ØºÙŠØ± Ù…ØªØµÙ„';
      }

      function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMinutes < 1) {
            return 'Ø§Ù„Ø¢Ù†';
        } else if (diffMinutes < 60) {
            return `Ù…Ù†Ø° ${diffMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
        } else if (diffHours < 24) {
            return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
        } else if (diffDays < 7) {
            return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
        } else {
            return date.toLocaleDateString('ar-EG');
        }
      }
    </script>
</script>
  </body>
</html>
