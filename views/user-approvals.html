<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)"
    />
    <meta
      name="keywords"
      content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ† â€“ Â«Ø§ÙÙÙ’Ø±ÙØ­ÙÙˆØ§ ÙÙÙŠ Ø§Ù„Ø±Ù‘ÙØ¨Ù‘Ù ÙƒÙÙ„Ù‘Ù Ø­ÙÙŠÙ†ÙÂ» (ÙÙŠÙ„Ø¨ÙŠ Ù¤: Ù¤)"
    />
    <meta name="author" content="ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†" />
    <meta name="theme-color" content="#402958" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ© | ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†</title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/UI/icon.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/design1.css" />
    <link rel="stylesheet" href="/design/sidebar.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
  </head>
  <body>
    <div class="mobile-toggle" id="mobileToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <img src="/UI/logo.png" alt="Ø§Ù„Ù„ÙˆØºÙˆ" />
          <div class="logo-text">
            <h1>ÙƒØ§ØªØ¯Ø±Ø§Ø¦ÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø¦ÙŠÙŠÙ†</h1>
            <p>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</p>
          </div>
        </div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item">
          <a href="http://localhost:3000" class="nav-link">
            <i class="fas fa-home"></i>
            Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          </a>
        </div>
        <div class="nav-item">
          <a href="/form-panel" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
          </a>
        </div>

        <div class="nav-item grades-nav-item">
          <div class="nav-link grades-toggle" id="gradesToggle">
            <i class="fas fa-graduation-cap"></i>
            Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="grades-submenu-container">
            <div class="grades-submenu" id="gradesSubmenu">
              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="prep">
                  <i class="fas fa-school"></i>
                  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="prep">
                  <a href="/grades/prep1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø£ÙˆÙ„
                  </a>
                  <a href="/grades/prep2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù†ÙŠ
                  </a>
                  <a href="/grades/prep3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ Ø«Ø§Ù„Ø«
                  </a>
                </div>
              </div>

              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="sec">
                  <i class="fas fa-university"></i>
                  Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="sec">
                  <a href="/grades/sec1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø£ÙˆÙ„
                  </a>
                  <a href="/grades/sec2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù†ÙŠ
                  </a>
                  <a href="/grades/sec3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    Ø«Ø§Ù†ÙˆÙŠ Ø«Ø§Ù„Ø«
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-item">
          <a href="/admin/user-approvals" class="nav-link active">
            <i class="fas fa-user-check"></i>
            Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/user-management" class="nav-link">
            <i class="fas fa-users"></i>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/add" class="nav-link">
            <i class="fas fa-plus-circle"></i>
            Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯ÙŠØ©
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/approvals" class="nav-link">
            <i class="fas fa-check-circle"></i>
            Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
          </a>
        </div>

        <div class="nav-item suggestions-nav-item">
          <div class="nav-link suggestions-toggle" id="suggestionsToggle">
            <i class="fas fa-lightbulb"></i>
            Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="suggestions-submenu-container">
            <div class="suggestions-submenu" id="suggestionsSubmenu">
              <a
                href="/admin/suggestion/ektma3at"
                class="nav-link submenu-link"
              >
                <i class="fas fa-users"></i>
                Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª
              </a>
            </div>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </aside>

    <main class="main-content">
      <div class="admin-container">
        <h1><i class="fas fa-user-check"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h1>

        <div class="filters">
          <div class="filter-group">
            <label for="filter-grade">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ:</label>
            <select id="filter-grade" class="filter-select">
              <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
              <option value="prep1">Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
              <option value="prep2">Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
              <option value="prep3">Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
              <option value="sec1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="sec2">Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
              <option value="sec3">Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filter-date">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <select id="filter-date" class="filter-select">
              <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
              <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
            </select>
          </div>
          <button id="refreshBtn" class="toggle-btn refresh-btn">
            <i class="fas fa-sync-alt"></i>
            ØªØ­Ø¯ÙŠØ«
          </button>
        </div>

        <div id="registrationsList" class="registrations-grid">
          <div class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
          </div>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
      defer
    ></script>
    <script>
      const mobileToggle = document.getElementById("mobileToggle");
      const sidebar = document.getElementById("sidebar");
      const logoutBtn = document.getElementById("logoutBtn");
      const logoutBtnMobile = document.getElementById("logoutBtnMobile");
      const registrationsList = document.getElementById("registrationsList");
      const filterGrade = document.getElementById("filter-grade");
      const filterDate = document.getElementById("filter-date");
      const refreshBtn = document.getElementById("refreshBtn");

      const gradesToggle = document.getElementById("gradesToggle");
      const gradesSubmenu = document.getElementById("gradesSubmenu");
      const sectionToggles = document.querySelectorAll(".section-toggle");

      function toggleSidebar() {
        sidebar.classList.toggle("active");
        const spans = mobileToggle.querySelectorAll("span");
        if (sidebar.classList.contains("active")) {
          spans[0].style.transform = "rotate(45deg) translate(5px, 5px)";
          spans[1].style.opacity = "0";
          spans[2].style.transform = "rotate(-45deg) translate(7px, -6px)";
        } else {
          spans[0].style.transform = "none";
          spans[1].style.opacity = "1";
          spans[2].style.transform = "none";
        }
      }

      if (mobileToggle) {
        mobileToggle.addEventListener("click", toggleSidebar);
      }

      if (gradesToggle) {
        gradesToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            gradesSubmenu.style.maxHeight = "250px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            gradesSubmenu.style.maxHeight = "0";
            document
              .querySelectorAll(".section-toggle.active")
              .forEach((toggle) => {
                toggle.classList.remove("active");
                const subIcon = toggle.querySelector(".toggle-icon");
                subIcon.classList.remove("fa-chevron-up");
                subIcon.classList.add("fa-chevron-down");
                const sectionSub = document.querySelector(
                  `.section-submenu[data-section="${toggle.dataset.section}"]`
                );
                if (sectionSub) sectionSub.style.maxHeight = "0";
              });
          }
        });
      }

      sectionToggles.forEach((toggle) => {
        toggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          const sectionSub = document.querySelector(
            `.section-submenu[data-section="${this.dataset.section}"]`
          );

          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            sectionSub.style.maxHeight = sectionSub.scrollHeight + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            sectionSub.style.maxHeight = "0";
          }
        });
      });

      async function loadUserInfo() {
        try {
          const response = await fetch("/api/user-info");
          const data = await response.json();
          if (!data.isAuthenticated) {
            window.location.href = "/login";
            return;
          }
          document.getElementById("username").textContent = data.username;
          document.getElementById("userRole").textContent =
            data.role === "leadadmin"
              ? "Ù‚Ø§Ø¦Ø¯ Ø¹Ø§Ù…"
              : data.role === "admin"
              ? "Ù…Ø´Ø±Ù"
              : data.role;
        } catch (error) {
          console.error("Error loading user info:", error);
        }
      }

      async function loadRegistrations() {
        registrationsList.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            `;

        try {
          const response = await fetch("/api/registrations");
          const registrations = await response.json();

          if (!registrations || registrations.length === 0) {
            registrationsList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-clock"></i>
                            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</h3>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                        </div>
                    `;
            return;
          }

          let filteredRegistrations = [...registrations];

          const gradeFilter = filterGrade.value;
          if (gradeFilter !== "all") {
            filteredRegistrations = filteredRegistrations.filter(
              (reg) => reg.grade === gradeFilter
            );
          }

          if (filterDate.value === "newest") {
            filteredRegistrations.sort(
              (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            );
          } else {
            filteredRegistrations.sort(
              (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
            );
          }

          registrationsList.innerHTML = filteredRegistrations
            .map((reg) => {
              const gradeText =
                {
                  prep1: "Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
                  prep2: "Ø«Ø§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
                  prep3: "Ø«Ø§Ù„Ø«Ø© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
                  sec1: "Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ",
                  sec2: "Ø«Ø§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ",
                  sec3: "Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ",
                  teachers: "Ø®Ø§Ø¯Ù…",
                  admins: "Ù…Ø´Ø±Ù",
                }[reg.grade] || reg.grade;

              return `
                        <div class="registration-card">
                            <div class="registration-header">
                                <div class="user-avatar-small">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="registration-info">
                                    <h3>${reg.firstName} ${reg.secondName}</h3>
                                    <span class="username">@${
                                      reg.username
                                    }</span>
                                </div>
                                <span class="registration-grade">${gradeText}</span>
                            </div>
                            
                            <div class="registration-details">
                                <div class="detail-item">
                                    <span class="detail-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                                    <span class="detail-value">${
                                      reg.email
                                    }</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span>
                                    <span class="detail-value">${
                                      reg.phone
                                    }</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</span>
                                    <span class="detail-value">${new Date(
                                      reg.createdAt
                                    ).toLocaleString("ar-EG")}</span>
                                </div>
                            </div>
                            
                            <div class="registration-actions">
                                <button class="action-btn approve-btn" onclick="approveRegistration('${
                                  reg._id
                                }')">
                                    <i class="fas fa-check"></i>
                                    Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
                                </button>
                                <button class="action-btn decline-btn" onclick="declineRegistration('${
                                  reg._id
                                }')">
                                    <i class="fas fa-times"></i>
                                    Ø§Ù„Ø±ÙØ¶
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading registrations:", error);
          registrationsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
                        <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
                    </div>
                `;
        }
      }

      async function approveRegistration(id) {
        const result = await Swal.fire({
          title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
          text: "Ø³ÙŠØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
          icon: "question",
          showCancelButton: true,
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonText: "Ù†Ø¹Ù…ØŒ Ù…ÙˆØ§ÙÙ‚Ø©",
          confirmButtonColor: "#27ae60",
          cancelButtonColor: "#666",
        });

        if (result.isConfirmed) {
          Swal.fire({
            title: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...",
            html: '<i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #ffcc00;"></i>',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: async () => {
              try {
                const response = await fetch(
                  `/api/registrations/${id}/approve`,
                  {
                    method: "POST",
                  }
                );

                if (response.ok) {
                  const result = await response.json();
                  const verificationCode = result.verificationCode;
                  Swal.fire({
                    title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                    html: verificationCode
                      ? `
                                        <p>ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­</p>
                                        <div style="background: rgba(255, 204, 0, 0.1); border: 2px solid #ffcc00; border-radius: 12px; padding: 20px; margin: 20px 0;">
                                            <p style="color: #ffcc00; font-weight: 700; margin-bottom: 10px;">ğŸ”‘ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚:</p>
                                            <p style="font-size: 24px; font-weight: 800; color: #ffcc00; font-family: monospace; letter-spacing: 3px;">${verificationCode} <i class="fas fa-copy copy-icon" onclick="copyToClipboard('${verificationCode}')" style="cursor: pointer;"></i></p>
                                            <p style="color: #fff; margin-top: 10px; font-size: 14px;">âš ï¸ Ø£Ø±Ø³Ù„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø³Ø§Ø¨Ù‡</p>
                                        </div>
                                    `
                      : "<p>ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­</p>",
                    icon: "success",
                    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                    confirmButtonColor: "#ffcc00",
                    width: "500px",
                  });
                  loadRegistrations();
                } else {
                  throw new Error("ÙØ´Ù„ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨");
                }
              } catch (error) {
                Swal.fire({
                  title: "Ø®Ø·Ø£!",
                  text: error.message || "ØªØ¹Ø°Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨",
                  icon: "error",
                  confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                });
              }
            },
          });
        }
      }

      async function copyToClipboard(text) {
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
          }

          await Swal.fire({
            title: "ØªÙ… Ø§Ù„Ù†Ø³Ø®",
            text: "ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­",
            icon: "success",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            confirmButtonColor: "#ffcc00",
            timer: 1600,
            timerProgressBar: true,
          });
        } catch (e) {
          await Swal.fire({
            title: "ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®",
            text: "ØªØ¹Ø°Ø± Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            confirmButtonColor: "#e74c3c",
          });
        }
      }

      async function declineRegistration(id) {
        const { value: reason } = await Swal.fire({
          title: "Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶",
          input: "textarea",
          inputLabel: "Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
          inputPlaceholder: "Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶...",
          showCancelButton: true,
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonText: "Ø±ÙØ¶",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
        });

        if (reason !== undefined) {
          Swal.fire({
            title: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...",
            html: '<i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #ffcc00;"></i>',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: async () => {
              try {
                const response = await fetch(
                  `/api/registrations/${id}/decline`,
                  {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ reason }),
                  }
                );

                if (response.ok) {
                  Swal.fire({
                    title: "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!",
                    text: "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­",
                    icon: "success",
                    confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                    confirmButtonColor: "#ffcc00",
                  });
                  loadRegistrations();
                } else {
                  throw new Error("ÙØ´Ù„ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
                }
              } catch (error) {
                Swal.fire({
                  title: "Ø®Ø·Ø£!",
                  text: error.message || "ØªØ¹Ø°Ø± Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨",
                  icon: "error",
                  confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
                });
              }
            },
          });
        }
      }

      async function viewRegistrationDetails(id) {
        try {
          const response = await fetch(`/api/registrations/${id}`);
          const registration = await response.json();

          Swal.fire({
            title: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨",
            html: `
                        <div style="text-align: right;">
                            <p><strong>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</strong> ${
                              registration.firstName
                            } ${registration.secondName}</p>
                            <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> @${
                              registration.username
                            }</p>
                            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${
                              registration.email
                            }</p>
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${
                              registration.phone
                            }</p>
                            <p><strong>Ø§Ù„ØµÙ:</strong> ${registration.grade}</p>
                            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</strong> ${new Date(
                              registration.createdAt
                            ).toLocaleString("ar-EG")}</p>
                            <p><strong>IP Address:</strong> ${
                              registration.ipAddress || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
                            }</p>
                            <p><strong>User Agent:</strong> ${
                              registration.userAgent || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
                            }</p>
                        </div>
                    `,
            icon: "info",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
            confirmButtonColor: "#ffcc00",
          });
        } catch (error) {
          Swal.fire({
            title: "Ø®Ø·Ø£!",
            text: "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨",
            icon: "error",
            confirmButtonText: "Ø­Ø³Ù†Ø§Ù‹",
          });
        }
      }

      async function performLogout() {
        const result = await Swal.fire({
          title: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
          text: "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ",
          icon: "question",
          iconColor: "#ffcc00",
          showCancelButton: true,
          confirmButtonText: "Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬",
          cancelButtonText: "Ø¥Ù„ØºØ§Ø¡",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
          background: "#2a1b3c",
          color: "#fff",
          backdrop: "rgba(0,0,0,0.8)",
          allowOutsideClick: false,
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch("/logout", { method: "POST" });
            if (response.ok) {
              await Swal.fire({
                title: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                text: "ÙˆØ¯Ø§Ø¹Ø§Ù‹! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ø¨Ù†Ø¬Ø§Ø­",
                icon: "success",
                iconColor: "#27ae60",
                background: "#2a1b3c",
                color: "#fff",
                backdrop: "rgba(0,0,0,0.8)",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "/";
              }, 500);
            }
          } catch (error) {
            console.error("Logout error:", error);
            window.location.href = "/";
          }
        }
      }

      if (logoutBtn) logoutBtn.addEventListener("click", performLogout);
      if (logoutBtnMobile)
        logoutBtnMobile.addEventListener("click", performLogout);

      if (filterGrade) filterGrade.addEventListener("change", loadRegistrations);
      if (filterDate) filterDate.addEventListener("change", loadRegistrations);
      if (refreshBtn) refreshBtn.addEventListener("click", loadRegistrations);

      document.addEventListener("click", function (event) {
        if (window.innerWidth <= 992) {
          if (
            !sidebar.contains(event.target) &&
            !mobileToggle.contains(event.target)
          ) {
            sidebar.classList.remove("active");
            const spans = mobileToggle.querySelectorAll("span");
            spans[0].style.transform = "none";
            spans[1].style.opacity = "1";
            spans[2].style.transform = "none";
          }
        }
      });

      document.addEventListener("DOMContentLoaded", function () {
        loadUserInfo();
        loadRegistrations();
        setInterval(loadRegistrations, 30000);
      });
    </script>

    <style>
      .filters {
        display: flex;
        gap: 20px;
        margin: 30px 0;
        align-items: center;
        flex-wrap: wrap;
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-group label {
        color: var(--light);
        font-weight: 600;
        font-size: 14px;
      }

      .filter-select {
        padding: 10px 15px;
        background: rgba(64, 41, 88, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: var(--light) !important;
        font-size: 14px;
        min-width: 200px;
        cursor: pointer;
      }

      .filter-select option {
        background: rgba(64, 41, 88, 0.95) !important;
        color: var(--light) !important;
        padding: 10px;
      }

      .filter-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2);
      }

      .refresh-btn,
      .toggle-btn {
        padding: 12px 22px;
        background: linear-gradient(90deg, var(--secondary), var(--primary));
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        font-size: 15px;
        font-weight: 800;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all var(--transition-speed);
        white-space: nowrap;
        will-change: transform;
        min-height: 44px;
        margin-top: 30px;
      }

      .refresh-btn:hover,
      .toggle-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.28);
        border-color: rgba(255, 204, 0, 0.22);
      }

      .refresh-btn:active {
        transform: translateY(0);
      }

      .refresh-btn i,
      .toggle-btn i {
        transition: transform 0.35s ease;
      }

      .refresh-btn:hover i,
      .toggle-btn:hover i {
        transform: rotate(180deg);
      }

      .registrations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 25px;
        margin-top: 20px;
      }

      .registration-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        transition: all var(--transition-speed);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .registration-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .registration-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .user-avatar-small {
        width: 50px;
        height: 50px;
        background: rgba(255, 204, 0, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: var(--accent);
      }

      .registration-info {
        flex-grow: 1;
      }

      .registration-info h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--light);
        margin-bottom: 5px;
      }

      .username {
        font-size: 14px;
        color: #bdc3c7;
        background: rgba(52, 73, 94, 0.5);
        padding: 3px 10px;
        border-radius: 12px;
      }

      .registration-grade {
        padding: 5px 15px;
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .registration-details {
        display: grid;
        gap: 12px;
        margin-bottom: 25px;
      }

      .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
      }

      .detail-label {
        font-size: 12px;
        color: #95a5a6;
        font-weight: 600;
      }

      .detail-value {
        font-size: 14px;
        color: var(--light);
        font-weight: 500;
      }

      .registration-actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .registration-actions .action-btn {
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all var(--transition-speed);
      }

      .approve-btn {
        background: rgba(39, 174, 96, 0.2);
        color: #27ae60;
        border: 1px solid rgba(39, 174, 96, 0.3);
      }

      .approve-btn:hover {
        background: #27ae60;
        color: white;
        transform: translateY(-2px);
      }

      .decline-btn {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 1px solid rgba(231, 76, 60, 0.3);
      }

      .decline-btn:hover {
        background: #e74c3c;
        color: white;
        transform: translateY(-2px);
      }

      .registration-actions .view-btn {
        background: rgba(52, 152, 219, 0.2);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }

      .registration-actions .view-btn:hover {
        background: #3498db;
        color: white;
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .registrations-grid {
          grid-template-columns: 1fr;
        }

        .registration-actions {
          grid-template-columns: repeat(2, 1fr);
        }

        .filters {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-select {

    <script>
      const suggestionsToggle = document.getElementById("suggestionsToggle");
      const suggestionsSubmenu = document.getElementById("suggestionsSubmenu");

      if (suggestionsToggle) {
        suggestionsToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            suggestionsSubmenu.style.maxHeight =
              suggestionsSubmenu.scrollHeight + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        });
      }

      document.addEventListener("click", function (e) {
        if (!e.target.closest(".suggestions-nav-item")) {
          const suggestionsToggle =
            document.getElementById("suggestionsToggle");
          const suggestionsSubmenu =
            document.getElementById("suggestionsSubmenu");

          if (
            suggestionsToggle &&
            suggestionsToggle.classList.contains("active")
          ) {
            suggestionsToggle.classList.remove("active");
            const icon = suggestionsToggle.querySelector(".toggle-icon");
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        }
      });
    </script>
  </body>
</html>
