<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)" />
    <meta name="keywords" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)" />
    <meta name="author" content="كاتدرائية السمائيين" />
    <meta name="theme-color" content="#402958" />
    <meta name="robots" content="noindex, nofollow" />
    <title>إضافة هدية | كاتدرائية السمائيين</title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/UI/icon.png" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
      defer
    ></script>
    <link rel="stylesheet" href="/design/design1.css" />
    <link rel="stylesheet" href="/design/design5.css" />
    <link rel="stylesheet" href="/design9.css" />
    <link rel="stylesheet" href="/design8.css" />
    <link rel="stylesheet" href="/design/sidebar.css" />
  </head>
  <body>
    <div class="mobile-toggle" id="mobileToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>

    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <img src="/UI/logo.png" alt="اللوغو" />
          <div class="logo-text">
            <h1>كاتدرائية السمائيين</h1>
            <p>لوحة تحكم النماذج</p>
          </div>
        </div>
      </div>

      <nav class="nav-menu">
        <div class="nav-item">
          <a
            href="http://localhost:3000"
            class="nav-link"
          >
            <i class="fas fa-home"></i>
            الصفحة الرئيسية
          </a>
        </div>
        <div class="nav-item">
          <a href="/form-panel" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            النماذج
          </a>
        </div>

        <div class="nav-item grades-nav-item">
          <div class="nav-link grades-toggle" id="gradesToggle">
            <i class="fas fa-graduation-cap"></i>
            الصفوف الدراسية
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="grades-submenu-container">
            <div class="grades-submenu" id="gradesSubmenu">
              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="prep">
                  <i class="fas fa-school"></i>
                  الإعدادية
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="prep">
                  <a href="/grades/prep1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    إعدادي أول
                  </a>
                  <a href="/grades/prep2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    إعدادي ثاني
                  </a>
                  <a href="/grades/prep3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    إعدادي ثالث
                  </a>
                </div>
              </div>

              <div class="submenu-header">
                <div class="nav-link section-toggle" data-section="sec">
                  <i class="fas fa-university"></i>
                  الثانوية
                  <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="section-submenu" data-section="sec">
                  <a href="/grades/sec1" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    ثانوي أول
                  </a>
                  <a href="/grades/sec2" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    ثانوي ثاني
                  </a>
                  <a href="/grades/sec3" class="nav-link submenu-link">
                    <i class="fas fa-arrow-left"></i>
                    ثانوي ثالث
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="nav-item">
          <a href="/admin/user-approvals" class="nav-link">
            <i class="fas fa-user-check"></i>
            طلبات التسجيل
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/user-management" class="nav-link">
            <i class="fas fa-users"></i>
            إدارة المستخدمين
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/add" class="nav-link active">
            <i class="fas fa-plus-circle"></i>
            إضافة هدية
          </a>
        </div>
        <div class="nav-item">
          <a href="/admin/gift-shop/approvals" class="nav-link">
            <i class="fas fa-check-circle"></i>
            طلبات المراجعة
          </a>
        </div>

        <div class="nav-item suggestions-nav-item">
          <div class="nav-link suggestions-toggle" id="suggestionsToggle">
            <i class="fas fa-lightbulb"></i>
            الاقتراحات
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="suggestions-submenu-container">
            <div class="suggestions-submenu" id="suggestionsSubmenu">
              <a
                href="/admin/suggestion/ektma3at"
                class="nav-link submenu-link"
              >
                <i class="fas fa-users"></i>
                اقتراحات الاجتماعات
              </a>
            </div>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          تسجيل الخروج
        </button>
      </div>
    </aside>

    <main class="main-content">
      <header class="top-nav">
        <div class="user-info">
          <img src="/UI/pfp.jpg" alt="المستخدم" class="user-avatar" />
          <div class="user-details">
            <h3 id="username-display">جاري التحميل...</h3>
            <span id="user-role-pill" class="role-badge">مشرف</span>
          </div>
        </div>
      </header>

      <div class="admin-container">
        <h1><i class="fas fa-plus-circle"></i> إدارة متجر الهدايا</h1>

        <button id="add-item-btn" class="create-form-btn">
          <i class="fas fa-plus"></i>
          إضافة عنصر جديد
        </button>

        <h2 class="section-title">
          <i class="fas fa-gift"></i>
          العناصر الموجودة
        </h2>

        <div id="admin-items-list" class="gift-shop-grid">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>جاري التحميل...</h3>
          </div>
        </div>
      </div>
    </main>

    <div id="add-item-modal" class="modal">
      <div class="modal-content">
        <button class="close-button" id="close-modal-btn">&times;</button>
        <h2><i class="fas fa-plus"></i> إضافة عنصر جديد</h2>
        <form id="add-item-form">
          <label>اسم العنصر:</label>
          <input type="text" id="item-name" required />

          <label>الوصف:</label>
          <textarea id="item-description" rows="3"></textarea>

          <label>التكلفة (نقاط):</label>
          <input type="number" id="item-cost" required min="1" />

          <label>الكمية المتاحة (-1 للغير محدود):</label>
          <input type="number" id="item-stock" value="-1" />

          <label>الحد الأقصى للشراء لكل مستخدم (-1 للغير محدود):</label>
          <input type="number" id="item-purchase-limit" value="-1" />

          <label>رابط الصورة:</label>
          <input
            type="url"
            id="item-image"
            placeholder="https://example.com/image.jpg"
          />

          <button type="submit" class="submit-btn">
            <i class="fas fa-plus"></i>
            إضافة العنصر
          </button>
        </form>
      </div>
    </div>

    <script>
      async function loadUserInfo() {
        try {
          const response = await fetch("/api/user-info");
          const data = await response.json();
          if (!data.isAuthenticated) {
            window.location.href = "/login";
            return;
          }
          if (data.role !== "admin" && data.role !== "leadadmin") {
            window.location.href = "/403";
            return;
          }
          document.getElementById("username-display").textContent =
            data.username;
          document.getElementById("user-role-pill").textContent =
            data.role === "leadadmin" ? "ليد أدمن" : "أدمن";
        } catch (error) {
          console.error("Error fetching user info:", error);
        }
      }

      async function loadAdminItems() {
        try {
          const response = await fetch("/api/admin/gift-shop/items");
          const items = await response.json();
          const list = document.getElementById("admin-items-list");

          if (!items || items.length === 0) {
            list.innerHTML =
              '<div class="empty-state"><i class="fas fa-gift"></i><h3>لا توجد عناصر</h3><p>لم يتم إضافة أي عناصر بعد</p></div>';
            return;
          }

          list.innerHTML = items
            .map(
              (item) => `
                    <div class="gift-item admin-item">
                        ${
                          item.image
                            ? `<img src="${item.image}" alt="${item.name}" loading="lazy">`
                            : '<div class="no-image"><i class="fas fa-gift"></i></div>'
                        }
                        <h3>${item.name}</h3>
                        <p>${item.description || ""}</p>
                        <div class="gift-meta">
                            <div class="cost">${item.cost} نقطة</div>
                            <span class="stock ${
                              item.active ? "active" : "inactive"
                            }">
                                ${item.active ? "نشط" : "غير نشط"}
                            </span>
                        </div>
                        <div class="admin-actions">
                            <button onclick="toggleItemActive('${
                              item._id
                            }', ${!item.active})" 
                                    class="${
                                      item.active
                                        ? "deactivate-btn"
                                        : "activate-btn"
                                    }">
                                <i class="fas fa-power-off"></i>
                                ${item.active ? "تعطيل" : "تفعيل"}
                            </button>
                            <button onclick="deleteItem('${
                              item._id
                            }')" class="delete-btn">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading admin items:", error);
        }
      }

      async function toggleItemActive(itemId, newStatus) {
        try {
          const response = await fetch(`/api/admin/gift-shop/items/${itemId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ active: newStatus }),
          });
          const result = await response.json();

          if (response.ok) {
            loadAdminItems();
          } else {
            throw new Error(result.message || "فشل التحديث");
          }
        } catch (error) {
          Swal.fire({
            title: "خطأ!",
            text: error.message || "تعذر تحديث العنصر",
            icon: "error",
            confirmButtonText: "حسنًا",
          });
        }
      }

      async function deleteItem(itemId) {
        const result = await Swal.fire({
          title: "هل أنت متأكد؟",
          text: "هل أنت متأكد أنك تريد حذف هذا العنصر؟",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "نعم، احذف",
          cancelButtonText: "إلغاء",
          confirmButtonColor: "#e74c3c",
          cancelButtonColor: "#666",
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch(
              `/api/admin/gift-shop/items/${itemId}`,
              {
                method: "DELETE",
              }
            );
            const result = await response.json();

            if (response.ok) {
              Swal.fire({
                title: "تم الحذف!",
                text: "تم حذف العنصر بنجاح",
                icon: "success",
                confirmButtonText: "حسنًا",
                confirmButtonColor: "#ffcc00",
              });
              loadAdminItems();
            } else {
              throw new Error(result.message || "فشل الحذف");
            }
          } catch (error) {
            Swal.fire({
              title: "خطأ!",
              text: error.message || "تعذر حذف العنصر",
              icon: "error",
              confirmButtonText: "حسنًا",
            });
          }
        }
      }

      function showAddItemModal() {
        const modal = document.getElementById("add-item-modal");
        if (modal) {
          modal.style.display = "flex";
          modal.classList.add("active");
          modal.classList.add("show");
          document.body.style.overflow = "hidden";
          setTimeout(() => {
            const firstInput = modal.querySelector("input");
            if (firstInput) firstInput.focus();
          }, 100);
        }
      }

      function closeAddItemModal() {
        const modal = document.getElementById("add-item-modal");
        if (modal) {
          modal.style.display = "none";
          modal.classList.remove("show");
          modal.classList.remove("active");
          document.body.style.overflow = "";
          const form = document.getElementById("add-item-form");
          if (form) form.reset();
        }
      }

      document.addEventListener("click", function (event) {
        const modal = document.getElementById("add-item-modal");
        if (modal && event.target === modal) {
          closeAddItemModal();
        }
      });

      document
        .getElementById("add-item-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            name: document.getElementById("item-name").value,
            description: document.getElementById("item-description").value,
            cost: parseInt(document.getElementById("item-cost").value),
            stock: parseInt(document.getElementById("item-stock").value),
            purchaseLimit: parseInt(
              document.getElementById("item-purchase-limit").value
            ),
            image: document.getElementById("item-image").value,
          };

          const submitBtn = document.querySelector(
            "#add-item-form button[type='submit']"
          );
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> جاري الإضافة...';
          }

          try {
            const response = await fetch("/api/admin/gift-shop/items", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });
            const result = await response.json();

            if (response.ok) {
              Swal.fire({
                title: "تم!",
                text: "تم إضافة العنصر بنجاح",
                icon: "success",
                confirmButtonText: "حسنًا",
                confirmButtonColor: "#ffcc00",
              });
              closeAddItemModal();
              loadAdminItems();
            } else {
              throw new Error(result.message || "فشل الإضافة");
            }
          } catch (error) {
            Swal.fire({
              title: "خطأ!",
              text: error.message || "تعذر إضافة العنصر",
              icon: "error",
              confirmButtonText: "حسنًا",
            });
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.innerHTML = "إضافة العنصر";
            }
          }
        });

      document.addEventListener("DOMContentLoaded", async () => {
        await loadUserInfo();
        await loadAdminItems();

        document
          .getElementById("add-item-btn")
          .addEventListener("click", showAddItemModal);
        document
          .getElementById("close-modal-btn")
          .addEventListener("click", closeAddItemModal);

        const mobileToggle = document.getElementById("mobileToggle");
        const sidebar = document.getElementById("sidebar");
        const logoutBtn = document.getElementById("logoutBtn");

        const gradesToggle = document.getElementById("gradesToggle");
        const gradesSubmenu = document.getElementById("gradesSubmenu");
        const sectionToggles = document.querySelectorAll(".section-toggle");

        if (mobileToggle) {
          mobileToggle.addEventListener("click", () => {
            sidebar.classList.toggle("active");
          });
        }

        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            const result = await Swal.fire({
              title: "تسجيل الخروج",
              text: "هل تريد فعلاً تسجيل الخروج من النظام؟",
              icon: "question",
              iconColor: "#ffcc00",
              showCancelButton: true,
              confirmButtonText: "نعم، تسجيل خروج",
              cancelButtonText: "إلغاء",
              confirmButtonColor: "#e74c3c",
              cancelButtonColor: "#666",
              background: "#2a1b3c",
              color: "#fff",
              backdrop: "rgba(0,0,0,0.8)",
              allowOutsideClick: false,
            });

            if (result.isConfirmed) {
              try {
                const response = await fetch("/logout", { method: "POST" });
                if (response.ok) {
                  await Swal.fire({
                    title: "تم تسجيل الخروج",
                    text: "وداعاً! تم تسجيل خروجك بنجاح",
                    icon: "success",
                    iconColor: "#27ae60",
                    background: "#2a1b3c",
                    color: "#fff",
                    backdrop: "rgba(0,0,0,0.8)",
                    showConfirmButton: false,
                    timer: 1500,
                  });
                  setTimeout(() => {
                    window.location.href = "/";
                  }, 500);
                }
              } catch (error) {
                console.error("Logout error:", error);
                window.location.href = "/";
              }
            }
          });
        }

        if (gradesToggle) {
          gradesToggle.addEventListener("click", function (e) {
            e.stopPropagation();
            this.classList.toggle("active");
            const icon = this.querySelector(".toggle-icon");
            if (this.classList.contains("active")) {
              icon.classList.remove("fa-chevron-down");
              icon.classList.add("fa-chevron-up");
              gradesSubmenu.style.maxHeight = "250px";
            } else {
              icon.classList.remove("fa-chevron-up");
              icon.classList.add("fa-chevron-down");
              gradesSubmenu.style.maxHeight = "0";
              document
                .querySelectorAll(".section-toggle.active")
                .forEach((toggle) => {
                  toggle.classList.remove("active");
                  const subIcon = toggle.querySelector(".toggle-icon");
                  subIcon.classList.remove("fa-chevron-up");
                  subIcon.classList.add("fa-chevron-down");
                  const sectionSub = document.querySelector(
                    `.section-submenu[data-section="${toggle.dataset.section}"]`
                  );
                  if (sectionSub) sectionSub.style.maxHeight = "0";
                });
            }
          });
        }

        sectionToggles.forEach((toggle) => {
          toggle.addEventListener("click", function (e) {
            e.stopPropagation();
            this.classList.toggle("active");
            const icon = this.querySelector(".toggle-icon");
            const sectionSub = document.querySelector(
              `.section-submenu[data-section="${this.dataset.section}"]`
            );

            if (this.classList.contains("active")) {
              icon.classList.remove("fa-chevron-down");
              icon.classList.add("fa-chevron-up");
              sectionSub.style.maxHeight = sectionSub.scrollHeight + "px";
            } else {
              icon.classList.remove("fa-chevron-up");
              icon.classList.add("fa-chevron-down");
              sectionSub.style.maxHeight = "0";
            }
          });
        });
      });
    </script>


    <script>
      const suggestionsToggle = document.getElementById("suggestionsToggle");
      const suggestionsSubmenu = document.getElementById("suggestionsSubmenu");

      if (suggestionsToggle) {
        suggestionsToggle.addEventListener("click", function (e) {
          e.stopPropagation();
          this.classList.toggle("active");
          const icon = this.querySelector(".toggle-icon");
          if (this.classList.contains("active")) {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-up");
            suggestionsSubmenu.style.maxHeight =
              suggestionsSubmenu.scrollHeight + "px";
          } else {
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        });
      }

      document.addEventListener("click", function (e) {
        if (!e.target.closest(".suggestions-nav-item")) {
          const suggestionsToggle =
            document.getElementById("suggestionsToggle");
          const suggestionsSubmenu =
            document.getElementById("suggestionsSubmenu");

          if (
            suggestionsToggle &&
            suggestionsToggle.classList.contains("active")
          ) {
            suggestionsToggle.classList.remove("active");
            const icon = suggestionsToggle.querySelector(".toggle-icon");
            icon.classList.remove("fa-chevron-up");
            icon.classList.add("fa-chevron-down");
            suggestionsSubmenu.style.maxHeight = "0";
          }
        }
      });
    </script>
  </body>
</html>
