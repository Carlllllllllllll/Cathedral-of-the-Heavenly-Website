<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)">
    <meta name="keywords" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)">
    <meta name="author" content="كاتدرائية السمائيين">
    <meta name="theme-color" content="#402958">
    <meta name="robots" content="noindex, nofollow">
    <meta property="og:title" content="<%= gradeLabel.short || 'لوحة التحكم' %> | كاتدرائية السمائيين">
    <meta property="og:description" content="كاتدرائية السمائيين – «اِفْرَحُوا فِي الرَّبِّ كُلَّ حِينٍ» (فيلبي ٤: ٤)">
    <meta property="og:image" content="/UI/icon.png">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_AR">
    <title><%= gradeLabel.short || 'لوحة التحكم' %> | كاتدرائية السمائيين</title>
    <link rel="icon" href="/UI/icon.png" type="image/png" sizes="16x16">
    <link rel="apple-touch-icon" href="/UI/icon.png">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/design10.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-brand">
            <div class="brand-text">
                <h2>كاتدرائية السمائيين</h2>
                <p>لوحة التحكم</p>
            </div>
        </div>
        
        <div class="nav-center">
            
        </div>
        
        <div class="mobile-header-right">
    
            
            <div class="mobile-menu-btn" id="mobileMenuBtn">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="mobile-dropdown" id="mobileDropdown">
            <div class="mobile-buttons">
                <a href="/grades/<%= gradeSlug %>" class="nav-button" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    صفحة الصف
                </a>
                
                <a href="/gift-shop" class="nav-button" data-page="gift-shop">
                    <i class="fas fa-gift"></i>
                    متجر الهدايا
                </a>

                <button class="nav-button logout-btn-mobile-dropdown" id="logoutBtnMobile">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </nav>

    <section class="hero-section">
        <div class="welcome-card">
            <div class="welcome-content">
                <h1 class="welcome-title">اهلا, <%= user.username %>@</h1>
                <p class="welcome-subtitle">
                    <%= gradeMeta.heroSubtitle || 'مرحباً بك في منصة كاتدرائية السمائيين الرسمية، حيث يمكنك متابعة الأنشطة الروحية والنماذج التعليمية بكل احترافية.' %>
                </p>
                <div class="user-badges">
                    <div class="badge badge-role">
                        <i class="fas fa-user-tag"></i>
                        <%= user.role === 'student' ? 'طالب' : 'خادم' %>
                    </div>
                    <div class="badge badge-grade">
                        <i class="fas fa-graduation-cap"></i>
                        <%= gradeLabel.short || gradeSlug %>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="dashboard-content">
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-file-alt"></i>
                    النماذج النشطة
                </h2>
                <div class="section-count" id="formsCount">0</div>
            </div>
            <div class="forms-grid" id="formsContainer">
                <div class="loading-state">
                    <div class="loader"></div>
                    <p>جاري تحميل النماذج...</p>
                </div>
            </div>
        </div>
    </section>
</main>

<footer>
    <p>&copy; 2025 كاتدرائية السمائيين. جميع الحقوق محفوظة.</p>
</footer>

<script
  src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"
  defer
></script>
    <script src="/notifications.js" defer></script>
    <script>
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileDropdown = document.getElementById('mobileDropdown');
        const suggestionBtn = document.getElementById('suggestionBtn');
        const suggestionDropdown = document.getElementById('suggestionDropdown');
        const mobileSuggestionBtn = document.getElementById('mobileSuggestionBtn');
        const mobileSuggestionMenu = document.getElementById('mobileSuggestionMenu');
        const desktopArrow = document.getElementById('desktopArrow');
        const mobileArrow = document.getElementById('mobileArrow');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutBtnMobile = document.getElementById('logoutBtnMobile');
        const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
        
        mobileMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = mobileDropdown.classList.toggle('active');
            mobileMenuBtn.classList.toggle('open', isOpen);
        });

        if (suggestionBtn) {
            suggestionBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                suggestionDropdown.classList.toggle('active');
                desktopArrow.classList.toggle('rotated');
            });
        }

        if (mobileSuggestionBtn) {
            mobileSuggestionBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                mobileSuggestionMenu.classList.toggle('active');
                mobileArrow.classList.toggle('rotated');
            });
        }

        function hideCurrentPageFromNav() {
            const currentPage = 'dashboard';
            const navButtonsToHide = document.querySelectorAll('[data-page]');
            navButtonsToHide.forEach(element => {
                if (element.getAttribute('data-page') === currentPage) {
                    element.style.display = 'none';
                }
            });
        }
        document.addEventListener('DOMContentLoaded', hideCurrentPageFromNav);

        async function loadUserPoints() {
            try {
                const response = await fetch('/api/gift-shop/my-points');
                if (response.ok) {
                    const data = await response.json();
                    const points = data.points || 0;
                    document.getElementById('pointsValue').textContent = points;
                }
            } catch (error) {
                console.error('Error loading points:', error);
            }
        }

        async function loadActiveForms() {
            const formsContainer = document.getElementById('formsContainer');
            const formsCount = document.getElementById('formsCount');
            
            formsContainer.innerHTML = `
                <div class="loading-state">
                    <div class="loader"></div>
                    <p>جاري تحميل النماذج...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`/api/forms/active?grade=<%= gradeSlug %>`);
                
                if (!response.ok) {
                    formsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>لا توجد نماذج نشطة</h3>
                            <p>لا توجد نماذج متاحة حالياً. سيتم إعلامك عند توفر نماذج جديدة.</p>
                        </div>
                    `;
                    formsCount.textContent = '0';
                    return;
                }
                
                const forms = await response.json();
                
                if (!Array.isArray(forms) || forms.length === 0) {
                    formsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>لا توجد نماذج نشطة</h3>
                            <p>لا توجد نماذج متاحة حالياً. سيتم إعلامك عند توفر نماذج جديدة.</p>
                        </div>
                    `;
                    formsCount.textContent = '0';
                    return;
                }
                
                formsCount.textContent = forms.length;
                
                formsContainer.innerHTML = forms.map(form => `
                    <div class="form-card" onclick="window.location.href='/form/${form.link || form.id}'">
                        <div class="form-card-header">
                            <div class="form-icon">
                                <i class="fas ${form.icon || 'fa-file-alt'}"></i>
                            </div>
                            <span class="form-status status-active">
                                ${form.status === 'active' ? 'نشط' : 'مطلوب'}
                            </span>
                        </div>
                        <h3 class="form-title">${form.topic || form.title || 'نموذج بدون عنوان'}</h3>
                        <p class="form-description">${form.description || 'املأ هذا النموذج للمشاركة في النشاط.'}</p>
                        <div class="form-footer">
                            <span class="form-date">
                                ${form.expiry || form.deadline ? `ينتهي: ${new Date(form.expiry || form.deadline).toLocaleDateString('ar-EG')}` : 'بدون تاريخ انتهاء'}
                            </span>
                            <i class="fas fa-arrow-left form-arrow"></i>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                formsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>لا توجد نماذج نشطة</h3>
                        <p>لا توجد نماذج متاحة حالياً. سيتم إعلامك عند توفر نماذج جديدة.</p>
                    </div>
                `;
                formsCount.textContent = '0';
            }
        }

        async function performLogout() {
            const result = await Swal.fire({
                title: 'تسجيل الخروج',
                text: 'هل تريد فعلاً تسجيل الخروج من النظام؟',
                icon: 'question',
                iconColor: '#ffcc00',
                showCancelButton: true,
                confirmButtonText: 'نعم، تسجيل خروج',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#666',
                background: '#2a1b3c',
                color: '#fff',
                backdrop: 'rgba(0,0,0,0.8)',
                allowOutsideClick: false
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch('/logout', { method: 'POST' });
                    if (response.ok) {
                        await Swal.fire({
                            title: 'تم تسجيل الخروج',
                            text: 'وداعاً! تم تسجيل خروجك بنجاح',
                            icon: 'success',
                            iconColor: '#27ae60',
                            background: '#2a1b3c',
                            color: '#fff',
                            backdrop: 'rgba(0,0,0,0.8)',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 500);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    window.location.href = '/';
                }
            }
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', performLogout);
        }
        if (logoutBtnMobile) {
            logoutBtnMobile.addEventListener('click', performLogout);
        }
        if (mobileLogoutBtn) {
            mobileLogoutBtn.addEventListener('click', performLogout);
        }

        document.addEventListener('click', function(event) {
            if (!mobileMenuBtn.contains(event.target) && !mobileDropdown.contains(event.target)) {
                mobileDropdown.classList.remove('active');
                mobileMenuBtn.classList.remove('open');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadUserPoints();
            loadActiveForms();
        });
    </script>
</body>
</html>
